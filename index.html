<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¹ãƒ­ãƒƒãƒˆãƒã‚·ãƒ¼ãƒ³</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    /* å…¨ä½“ã®èƒŒæ™¯ã¨ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š */
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #1a1a1a, #303030);
      color: #fff;
      font-family: 'Press Start 2P', sans-serif;
      text-align: center;
    }
    /* ãƒã‚·ãƒ³å…¨ä½“ã®ã‚³ãƒ³ãƒ†ãƒŠï¼šãƒã‚ªãƒ³ã®æ ã¨å½± */
    .machine {
      margin: 30px auto;
      padding: 20px;
      background-color: #000;
      border: 4px solid #ff69b4;
      position: relative;
      display: inline-block;
      padding-bottom: 100px;
      /* ä¸‹éƒ¨ãƒœã‚¿ãƒ³åˆ†ã®ã‚¹ãƒšãƒ¼ã‚¹ */
      box-shadow: 0 0 15px #ff69b4;
    }
    /* ã‚¿ã‚¤ãƒˆãƒ«ï¼šå„æ–‡å­—ã«ãƒ—ãƒ«ã‚¹ï¼ˆé¼“å‹•ï¼‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸ */
    h1 {
      margin: 0 0 20px 0;
      font-size: 24px;
    }
    h1 span {
      display: inline-block;
      animation: pulse 1.5s infinite;
      color: #ff69b4;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1);
      text-shadow: 0 0 4px #ff69b4; }
      50% { transform: scale(1.1); text-shadow: 0 0 15px #ff69b4;
      }
    }
    /* ãƒªãƒ¼ãƒ«éƒ¨åˆ† */
    .reels {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      gap: 20px;
    }
    .reel-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    canvas {
      border: 3px solid #ff69b4;
      background-color: #222;
      image-rendering: pixelated; /* 8bitãƒ”ã‚¯ã‚»ãƒ«æ„Ÿã‚’å¼·èª¿ */
      width: 100px;
      height: 100px;
    }
    /* STOPãƒœã‚¿ãƒ³ï¼šé’ã„ãƒã‚ªãƒ³ */
    .stopButton {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: #2196F3;
      border: none;
      margin-top: 10px;
      cursor: pointer;
      box-shadow: 0 0 8px #2196F3;
      font-family: 'Press Start 2P', sans-serif;
    }
    .stopButton:disabled {
      background-color: #999;
      box-shadow: none;
      cursor: default;
    }
    /* STARTãƒœã‚¿ãƒ³ï¼šãƒã‚ªãƒ³ãƒ”ãƒ³ã‚¯ã®ã‚°ãƒ­ãƒ¼ */
    #startButton {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-family: 'Press Start 2P', sans-serif;
      font-size: 3.5vw; /* ä¿®æ­£ç®‡æ‰€ */
      padding: 10px 20px;
      background-color: #ff69b4;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 0 12px #ff69b4;
    }
    #startButton:disabled {
      background-color: #999;
      box-shadow: none;
    }
    /* çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    #result {
      margin: 10px 0;
      font-size: 4vw; /* ä¿®æ­£ç®‡æ‰€ */
      text-shadow: 0 0 8px #ff69b4;
    }
    /* ã‚¹ãƒãƒ›ãªã©å°ã•ã„ç”»é¢ç”¨ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–è¨­å®š */
    @media (max-width: 480px) {
      .machine {
        margin: 20px auto;
        padding: 15px;
      }
      h1 {
        font-size: 20px;
      }
      #startButton {
        font-size: 16px;
        padding: 8px 16px;
      }
      .stopButton {
        width: 40px;
        height: 40px;
      }
      canvas {
        width: 80px;
        height: 80px;
      }
    }
  </style>
</head>
<body>
  <div class="machine">
    <h1>ã‚¹ãƒ­ãƒƒãƒˆãƒã‚·ãƒ¼ãƒ³ v.1.0</h1>
    <div class="reels">
      <div class="reel-container">
        <canvas id="reel0" width="100" height="100"></canvas>
        <button class="stopButton" data-reel="0" disabled aria-label="Stop"></button>
      </div>
      <div class="reel-container">
        <canvas id="reel1" width="100" height="100"></canvas>
        <button class="stopButton" data-reel="1" disabled aria-label="Stop"></button>
      </div>
      <div class="reel-container">
        <canvas id="reel2" width="100" height="100"></canvas>
        <button class="stopButton" data-reel="2" disabled aria-label="Stop"></button>
      </div>
    </div>
    <p id="result"></p>
    <button id="startButton">START!</button>
  </div>

  <script>
    // ã‚¿ã‚¤ãƒˆãƒ«ã®å„æ–‡å­—ã‚’spanã§ãƒ©ãƒƒãƒ—ã—ã€å€‹åˆ¥ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨
    document.addEventListener('DOMContentLoaded', function() {
      var h1 = document.querySelector('h1');
      var text = h1.textContent;
      h1.innerHTML = '';
      for (var i = 0; i < text.length; i++) {
        var span = document.createElement('span');
        span.textContent = text[i];
        span.style.animationDelay = (i * 0.1) + 's';
        h1.appendChild(span);
      }
    });
    // è¨­å®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼šãƒªãƒ¼ãƒ«ã®ã‚µã‚¤ã‚ºæ‹¡å¤§
    const config = {
      symbolHeight: 100,      // ã‚·ãƒ³ãƒœãƒ«ã®é«˜ã•(px)
      reelWidth: 100,         // ãƒªãƒ¼ãƒ«ã®å¹…(px)
      reelHeight: 100,        // è¡¨ç¤ºçª“ã®é«˜ã•(px)
      rotationSpeed: 300,     // å›è»¢é€Ÿåº¦(px/ç§’)
      decelerationDuration: 500, // æ¸›é€Ÿæ™‚é–“(ms)
      symbols: ['ğŸ’', 'ğŸ‹', 'ğŸ””', 'ğŸ€', '7']
    };
    const cycleLength = config.symbols.length * config.symbolHeight;

    // --- ã‚ªãƒ•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆãƒ€ãƒ–ãƒ«ãƒãƒƒãƒ•ã‚¡ï¼‰ ---
    const offscreenCanvas = document.createElement('canvas');
    offscreenCanvas.width = config.reelWidth;
    offscreenCanvas.height = cycleLength * 2;
    const offCtx = offscreenCanvas.getContext('2d');
    offCtx.font = "60px 'Press Start 2P'";
    offCtx.textAlign = "center";
    offCtx.textBaseline = "middle";

    // ã‚·ãƒ³ãƒœãƒ«ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’2å›æç”»ã—ã¦ãƒ«ãƒ¼ãƒ—å¯èƒ½ã«
    for (let cycle = 0; cycle < 2; cycle++) {
      config.symbols.forEach((sym, i) => {
        const x = config.reelWidth / 2;
        const y = cycle * cycleLength + i * config.symbolHeight + (config.symbolHeight / 2);
        offCtx.fillText(sym, x, y);
      });
    }

    // --- å„ãƒªãƒ¼ãƒ«ã®çŠ¶æ…‹ç®¡ç† ---
    const reels = [];
    const reelCount = 3;
    for (let i = 0; i < reelCount; i++) {
      const canvas = document.getElementById("reel" + i);
      const ctx = canvas.getContext("2d");
      reels.push({
        canvas: canvas,
        ctx: ctx,
        currentOffset: 0,
        speed: config.rotationSpeed,
        spinning: false,
        stopping: false,
        stopStartTime: 0,
        startOffset: 0,
        targetOffset: 0
      });
    }

    const startButton = document.getElementById('startButton');
    const stopButtons = document.querySelectorAll('.stopButton');
    const resultP = document.getElementById('result');
    // è£œåŠ©é–¢æ•°ï¼šå¸¸ã«æ­£ã®å€¤ã®å‰°ä½™ã‚’è¿”ã™
    function mod(n, m) {
      return ((n % m) + m) % m;
    }

    // ãƒªãƒ¼ãƒ«æç”»
    function drawReel(reel) {
      const ctx = reel.ctx;
      ctx.clearRect(0, 0, config.reelWidth, config.reelHeight);
      const modOffset = mod(reel.currentOffset, cycleLength);
      ctx.drawImage(
        offscreenCanvas,
        0, modOffset, config.reelWidth, config.reelHeight,
        0, 0, config.reelWidth, config.reelHeight
      );
    }

    // STARTãƒœã‚¿ãƒ³å‡¦ç†ï¼šå„ãƒªãƒ¼ãƒ«åˆæœŸåŒ–ï¼†å›è»¢é–‹å§‹
    function startSpin() {
      startButton.disabled = true;
      resultP.textContent = "";
      reels.forEach((reel, idx) => {
        const randomIndex = Math.floor(Math.random() * config.symbols.length);
        reel.currentOffset = randomIndex * config.symbolHeight;
        drawReel(reel);
        setTimeout(() => {
          reel.spinning = true;
          reel.stopping = false;
          document.querySelector(`.stopButton[data-reel="${idx}"]`).disabled = false;
        }, idx * 200);
      });
    }

    // STOPãƒœã‚¿ãƒ³å‡¦ç†ï¼šãƒªãƒ¼ãƒ«åœæ­¢
    function stopReel(reelIndex) {
      const reel = reels[reelIndex];
      if (reel && reel.spinning && !reel.stopping) {
        reel.stopping = true;
        reel.stopStartTime = performance.now();
        reel.startOffset = reel.currentOffset;
        const remainder = mod(reel.currentOffset, config.symbolHeight);
        reel.targetOffset = reel.currentOffset - remainder;
        document.querySelector(`.stopButton[data-reel="${reelIndex}"]`).disabled = true;
      }
    }

    // å„STOPãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    stopButtons.forEach(button => {
      button.addEventListener('click', () => {
        stopReel(parseInt(button.getAttribute('data-reel'), 10));
      });
    });
    startButton.addEventListener('click', startSpin);

    // ãƒªãƒ¼ãƒ«ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°ï¼ˆrequestAnimationFrameï¼‰
    let lastTime = null;
    function animate(timestamp) {
      if (!lastTime) lastTime = timestamp;
      const dt = (timestamp - lastTime) / 1000;
      lastTime = timestamp;
      reels.forEach(reel => {
        if (reel.spinning && !reel.stopping) {
          reel.currentOffset -= reel.speed * dt;
        } else if (reel.spinning && reel.stopping) {
          const elapsed = timestamp - reel.stopStartTime;
          const progress = Math.min(elapsed / config.decelerationDuration, 1);
          const easeProgress = 1 - Math.pow(1 - progress, 2);
          reel.currentOffset = reel.startOffset - (reel.startOffset - reel.targetOffset) * easeProgress;
          if (progress >= 1) {
            reel.spinning = false;
            reel.stopping = false;
          }
        }
        drawReel(reel);
      });
      // å…¨ãƒªãƒ¼ãƒ«ãŒåœæ­¢ã—ãŸã‚‰æœ€çµ‚çµæœã‚’åˆ¤å®š
      if (reels.every(r => !r.spinning)) {
        const finalSymbols = reels.map(r => {
          // ã“ã“ã‚’ä¿®æ­£ï¼šå¸¸ã«æ­£ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å¾—ã‚‹ãŸã‚ã« mod() ã‚’åˆ©ç”¨
          const index = mod(Math.floor(r.currentOffset / config.symbolHeight), config.symbols.length);
          return config.symbols[index];
        });
        resultP.textContent =
          finalSymbols.every(s => s === finalSymbols[0]) ? "å¤§å½“ãŸã‚Šï¼" : "ã‚‚ã†ä¸€åº¦ï¼";
        startButton.disabled = false;
        stopButtons.forEach(btn => btn.disabled = true);
      }

      requestAnimationFrame(animate);
    }
    requestAnimationFrame(animate);
  </script>
</body>
</html>
